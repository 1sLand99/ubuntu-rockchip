From f4e643e57653e03555f3a0ddfdf00f7ded770475 Mon Sep 17 00:00:00 2001
From: Joshua Riek <jjriek@verizon.net>
Date: Sun, 18 Jun 2023 15:04:54 -0400
Subject: [PATCH] give sdcard higher boot priority than NVMe

---
 include/configs/rockchip-common.h | 26 ++++++++++++++++----------
 1 file changed, 16 insertions(+), 10 deletions(-)

diff --git a/include/configs/rockchip-common.h b/include/configs/rockchip-common.h
index 44de67c24..64e6320c5 100644
--- a/include/configs/rockchip-common.h
+++ b/include/configs/rockchip-common.h
@@ -70,13 +70,20 @@
 	#define BOOT_TARGET_SCSI(func)
 #endif
 
-/* First try to boot from SD (index 1), then eMMC (index 0) */
+/* First try to boot from SD (index 1), then NVME (if CMD_NVME is enabled), then eMMC (index 0) */
 #if CONFIG_IS_ENABLED(CMD_MMC)
-	#define BOOT_TARGET_MMC(func) \
-		func(MMC, mmc, 0) \
-		func(MMC, mmc, 1)
+	#if CONFIG_IS_ENABLED(CMD_NVME)
+		#define BOOT_TARGET_NVME_MMC(func) \
+			func(MMC, mmc, 1) \
+			func(NVME, nvme, 0) \
+			func(MMC, mmc, 0)
+	#else
+		#define BOOT_TARGET_NVME_MMC(func) \
+			func(MMC, mmc, 0) \
+			func(MMC, mmc, 1)
+	#endif
 #else
-	#define BOOT_TARGET_MMC(func)
+	#define BOOT_TARGET_NVME_MMC(func)
 #endif
 
 #if CONFIG_IS_ENABLED(CMD_MTD_BLK)
@@ -113,8 +120,7 @@
 #endif
 
 #define BOOT_TARGET_DEVICES(func) \
-	BOOT_TARGET_MMC(func) \
-	BOOT_TARGET_NVME(func) \
+	BOOT_TARGET_NVME_MMC(func) \
 	BOOT_TARGET_SCSI(func) \
 	BOOT_TARGET_MTD(func) \
 	BOOT_TARGET_RKNAND(func) \
@@ -163,10 +169,10 @@
 
 #define RKIMG_DET_BOOTDEV \
 	"rkimg_bootdev=" \
-	"if nvme dev 0; then " \
-		"setenv devtype nvme; setenv devnum 0; echo Boot from nvme;" \
-	"elif mmc dev 1 && rkimgtest mmc 1; then " \
+	"if mmc dev 1 && rkimgtest mmc 1; then " \
 		"setenv devtype mmc; setenv devnum 1; echo Boot from SDcard;" \
+	"elif nvme dev 0; then " \
+		"setenv devtype nvme; setenv devnum 0; echo Boot from nvme;" \
 	"elif mmc dev 0; then " \
 		"setenv devtype mmc; setenv devnum 0;" \
 	"elif mtd_blk dev 0; then " \
-- 
2.25.1

